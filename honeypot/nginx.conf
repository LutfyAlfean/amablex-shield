# HTTP Honeypot Decoy Configuration
# This serves fake admin pages to attract attackers

events {
    worker_connections 256;
}

http {
    include /etc/nginx/mime.types;
    default_type text/html;

    # Detailed logging for honeypot analysis
    log_format honeypot escape=json '{'
        '"timestamp":"$time_iso8601",'
        '"source_ip":"$remote_addr",'
        '"method":"$request_method",'
        '"path":"$request_uri",'
        '"status":"$status",'
        '"user_agent":"$http_user_agent",'
        '"referer":"$http_referer",'
        '"body":"$request_body",'
        '"headers":{'
            '"host":"$http_host",'
            '"accept":"$http_accept",'
            '"content_type":"$content_type",'
            '"content_length":"$content_length",'
            '"x_forwarded_for":"$http_x_forwarded_for"'
        '}'
    '}';

    access_log /var/log/nginx/honeypot.json honeypot;
    error_log /var/log/nginx/error.log warn;

    # Rate limiting
    limit_req_zone $binary_remote_addr zone=honeypot:10m rate=10r/s;
    limit_conn_zone $binary_remote_addr zone=addr:10m;

    server {
        listen 8080;
        server_name _;

        # Apply rate limiting
        limit_req zone=honeypot burst=20 nodelay;
        limit_conn addr 10;

        # Capture request body
        client_body_buffer_size 16k;
        client_max_body_size 1m;

        # Fake admin panel
        location / {
            root /usr/share/nginx/html;
            index index.html;
        }

        # Common attack targets - all return login page
        location ~ ^/(admin|wp-admin|administrator|phpmyadmin|manager|console|login|dashboard) {
            root /usr/share/nginx/html;
            try_files /login.html =200;
        }

        # Config/sensitive file traps
        location ~ \.(env|git|sql|bak|backup|conf|config|ini|log|yml|yaml|json)$ {
            return 403 "Access Denied";
        }

        # API endpoints trap
        location /api/ {
            return 401 '{"error": "Unauthorized", "message": "Invalid credentials"}';
            add_header Content-Type application/json;
        }

        # Shell/script traps
        location ~ \.(php|asp|aspx|jsp|cgi|pl|py|sh)$ {
            return 500 "Internal Server Error";
        }
    }
}
